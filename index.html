<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üé® Telestrations Game</title>
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    background-color: #cfe9ff;
    color: #333;
    margin: 0;
    padding: 0;
  }
  header {
    background-color: #5aa0ff;
    color: white;
    padding: 15px;
    font-size: 1.5em;
  }
  .container {
    max-width: 700px;
    margin: 20px auto;
    background: white;
    border-radius: 12px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    padding: 20px;
  }
  input, button, select {
    padding: 8px;
    margin: 5px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 1em;
  }
  button {
    background-color: #5aa0ff;
    color: white;
    cursor: pointer;
  }
  button:hover {
    background-color: #3a7adf;
  }
  canvas {
    border: 2px solid #333;
    background: #fff;
    border-radius: 10px;
  }
  #timer {
    font-weight: bold;
    color: #ff5252;
  }
</style>
</head>
<body>
<header>üé® Telestrations Game</header>
<div class="container" id="gameContainer">
  <div id="homeScreen">
    <h2>Create or Join a Room</h2>
    <button id="createRoomBtn">Create Room</button>
    <button id="joinRoomBtn">Join Room</button>
  </div>
  <div id="createRoom" style="display:none;">
    <h3>Host Game</h3>
    <label>Number of Players: <input id="numPlayers" type="number" min="3" max="12"></label><br>
    <button id="startHost">Next</button>
  </div>
  <div id="joinRoom" style="display:none;">
    <h3>Join Room</h3>
    <input id="joinCode" placeholder="Enter Room Code">
    <input id="joinName" placeholder="Your Name">
    <button id="joinGameBtn">Join</button>
  </div>
  <div id="hostWord" style="display:none;">
    <h3>Enter a Word or Phrase</h3>
    <input id="customWord" placeholder="Type a word or phrase">
    <button id="startGame">Start Game</button>
  </div>
  <div id="drawScreen" style="display:none;">
    <h3>Draw: <span id="drawPrompt"></span></h3>
    <canvas id="drawCanvas" width="400" height="300"></canvas><br>
    <label>Pen Size: 
      <select id="penSize">
        <option value="2">Small</option>
        <option value="5" selected>Medium</option>
        <option value="10">Large</option>
      </select>
    </label>
    <button id="undoBtn">Undo</button>
    <button id="clearBtn">Clear</button><br>
    <p>‚è≥ Time left: <span id="timer">60</span>s</p>
    <button id="submitDrawing">Submit</button>
  </div>
  <div id="guessScreen" style="display:none;">
    <h3>Guess the Word or Phrase</h3>
    <img id="guessImage" width="400" height="300"><br>
    <input id="guessInput" placeholder="Your Guess">
    <p>‚è≥ Time left: <span id="guessTimer">30</span>s</p>
    <button id="submitGuess">Submit Guess</button>
  </div>
  <div id="resultsScreen" style="display:none;">
    <h3>Results</h3>
    <div id="resultsList"></div>
  </div>
</div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, set, get, onValue, push, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD6LY0o8SfAqX08h3tuLheGJQ9YOm1IKE0",
    authDomain: "telestrations-game-aa386.firebaseapp.com",
    databaseURL: "https://telestrations-game-aa386-default-rtdb.firebaseio.com",
    projectId: "telestrations-game-aa386",
    storageBucket: "telestrations-game-aa386.firebasestorage.app",
    messagingSenderId: "461499249155",
    appId: "1:461499249155:web:c785ab9cd1c7aab44f1436"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // UI references
  const homeScreen = document.getElementById('homeScreen');
  const createRoomDiv = document.getElementById('createRoom');
  const joinRoomDiv = document.getElementById('joinRoom');
  const hostWordDiv = document.getElementById('hostWord');
  const drawScreen = document.getElementById('drawScreen');
  const guessScreen = document.getElementById('guessScreen');
  const resultsScreen = document.getElementById('resultsScreen');

  let playerName = "";
  let roomCode = "";
  let playerOrder = [];
  let currentTurn = 0;
  let numPlayers = 0;

  document.getElementById('createRoomBtn').onclick = () => {
    homeScreen.style.display = 'none';
    createRoomDiv.style.display = 'block';
  };

  document.getElementById('joinRoomBtn').onclick = () => {
    homeScreen.style.display = 'none';
    joinRoomDiv.style.display = 'block';
  };

  document.getElementById('startHost').onclick = async () => {
    numPlayers = parseInt(document.getElementById('numPlayers').value);
    if (!numPlayers || numPlayers < 3 || numPlayers > 12) return alert("Enter valid player count (3‚Äì12)");
    roomCode = Math.random().toString(36).substring(2, 6).toUpperCase();
    playerName = "Host";
    await set(ref(db, 'rooms/' + roomCode), {
      numPlayers, host: playerName, state: 'waiting', players: [playerName]
    });
    createRoomDiv.style.display = 'none';
    hostWordDiv.style.display = 'block';
  };

  document.getElementById('joinGameBtn').onclick = async () => {
    roomCode = document.getElementById('joinCode').value.toUpperCase();
    playerName = document.getElementById('joinName').value;
    const snap = await get(ref(db, 'rooms/' + roomCode));
    if (!snap.exists()) return alert("Room not found!");
    const data = snap.val();
    const players = data.players || [];
    if (players.length >= data.numPlayers) return alert("Room is full!");
    players.push(playerName);
    await update(ref(db, 'rooms/' + roomCode), { players });
    joinRoomDiv.innerHTML = `<h3>Joined Room ${roomCode}</h3><p>Waiting for host to start...</p>`;
  };

  document.getElementById('startGame').onclick = async () => {
    const word = document.getElementById('customWord').value.trim() || "Mystery Phrase";
    const snap = await get(ref(db, 'rooms/' + roomCode));
    const data = snap.val();
    const others = data.players.slice(1);
    others.sort(() => Math.random() - 0.5);
    playerOrder = [data.host, ...others];
    await update(ref(db, 'rooms/' + roomCode), {
      state: 'playing',
      word,
      playerOrder,
      turn: 0,
      actions: []
    });
    hostWordDiv.style.display = 'none';
    startDrawing(word);
  };

  function startDrawing(prompt) {
    drawScreen.style.display = 'block';
    document.getElementById('drawPrompt').textContent = prompt;
    const canvas = document.getElementById('drawCanvas');
    const ctx = canvas.getContext('2d');
    ctx.lineWidth = 5;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#000";
    let drawing = false;
    let undoStack = [];
    canvas.addEventListener('mousedown', e => { drawing = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); });
    canvas.addEventListener('mousemove', e => {
      if (!drawing) return;
      ctx.lineTo(e.offsetX, e.offsetY);
      ctx.stroke();
    });
    canvas.addEventListener('mouseup', () => { drawing = false; undoStack.push(canvas.toDataURL()); });

    document.getElementById('clearBtn').onclick = () => ctx.clearRect(0,0,canvas.width,canvas.height);
    document.getElementById('undoBtn').onclick = () => { if (undoStack.length>0){let img=new Image();img.src=undoStack.pop();img.onload=()=>ctx.drawImage(img,0,0);} };

    let timeLeft = 60;
    const timer = document.getElementById('timer');
    const interval = setInterval(() => {
      timeLeft--; timer.textContent = timeLeft;
      if (timeLeft <= 0) submit();
    }, 1000);
    document.getElementById('submitDrawing').onclick = submit;
    function submit() {
      clearInterval(interval);
      const img = canvas.toDataURL();
      push(ref(db, `rooms/${roomCode}/actions`), { type: 'draw', player: playerName, content: img });
      drawScreen.style.display = 'none';
      resultsScreen.style.display = 'block';
      document.getElementById('resultsList').innerHTML = "<h4>Submitted drawing. (Multiplayer relay continues in full version)</h4>";
    }
  }
</script>
</body>
</html>
