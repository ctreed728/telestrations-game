<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üé® Telestrations ‚Äî Multiplayer</title>
<style>
  :root{
    --bg-top:#cfefff;
    --bg-bottom:#8fd1ff;
    --card:#ffffff;
    --accent:#1e90ff;
    --accent-dark:#0b66b2;
    --muted:#375b6d;
  }
  *{box-sizing:border-box}
  body{
    margin:0;min-height:100vh;
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    background:linear-gradient(180deg,var(--bg-top),var(--bg-bottom));
    display:flex;align-items:flex-start;justify-content:center;padding:18px;color:#03263b;
  }
  .card{width:100%;max-width:1100px;border-radius:12px;padding:16px;background:var(--card);box-shadow:0 8px 30px rgba(10,30,60,0.08)}
  header{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:6px}
  header .emoji{font-size:28px}
  h1{margin:0;font-size:26px;color:var(--accent-dark)}
  p.lead{margin:6px 0 16px 0;color:var(--muted);text-align:center}
  .row{display:flex;gap:14px;flex-wrap:wrap}
  .col{flex:1 1 300px}
  .panel{background:#fbfdff;padding:12px;border-radius:10px;border:1px solid rgba(11,102,178,0.08)}
  label{display:block;margin-top:8px;font-weight:700;color:#123}
  input[type="text"], input[type="number"]{width:100%;padding:9px;border-radius:8px;border:1px solid #dbeffb;margin-top:6px;font-size:14px}
  button{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:10px;cursor:pointer;margin-top:10px;font-weight:700}
  button.ghost{background:transparent;color:var(--accent);border:2px solid var(--accent);padding:8px 12px}
  .muted{color:#516b7a;font-size:14px}
  canvas{background:#fff;border-radius:10px;border:2px solid #e6f6ff;display:block;touch-action:none;max-width:100%}
  .toolbar{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:8px;flex-wrap:wrap}
  .size-btn{padding:8px 12px;border-radius:8px;border:1px solid #e6eef9;background:#fff;cursor:pointer}
  .size-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  .controls{display:flex;gap:10px;align-items:center;justify-content:center;margin-top:10px;flex-wrap:wrap}
  .timer{font-weight:800;color:var(--accent-dark)}
  .chain-item{background:#fbfdff;border:1px solid #eef9ff;border-radius:10px;padding:10px;margin-top:8px;text-align:left}
  .summary-list{max-height:420px;overflow:auto;padding:6px}
  .hidden{display:none}
  @media(max-width:900px){ .row{flex-direction:column} .card{padding:12px} header{gap:8px} h1{font-size:20px} }
</style>
</head>
<body>
  <div class="card" id="app">
    <header><span class="emoji">üé®</span><h1>Telestrations ‚Äî Multiplayer</h1></header>
    <p class="lead">Create or join a room. Host draws first; others are randomized. Drawing 60s, guessing 30s.</p>

    <!-- HOME -->
    <div id="home">
      <div class="row">
        <div class="col panel">
          <h3 style="margin:0">Get started</h3>
          <label>Your name</label>
          <input id="nameInput" type="text" placeholder="e.g., Alex">
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="createRoomBtn">Create Room</button>
            <button id="joinRoomBtn" class="ghost">Join Room</button>
          </div>

          <div id="createArea" style="margin-top:12px">
            <label>Number of players (3‚Äì12)</label>
            <input id="playerCount" type="number" min="3" max="12" value="4">
            <label>Word or phrase (optional)</label>
            <input id="hostWord" placeholder="Custom word/phrase or click Suggest">
            <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
              <button id="suggestBtn" class="ghost">Suggest Word</button>
              <div id="suggestDisplay" style="font-weight:700;color:var(--accent)"></div>
            </div>
            <div style="margin-top:12px"><button id="doCreateBtn">Create & Open Room</button></div>
          </div>

          <div id="joinArea" style="margin-top:12px;display:none">
            <label>Room code</label>
            <input id="codeInput" placeholder="ABCD (4‚Äì6 letters)" maxlength="6">
            <div style="margin-top:8px"><button id="doJoinBtn">Join Room</button></div>
            <div id="joinMsg" class="muted" style="margin-top:8px"></div>
          </div>

          <div class="muted" id="status" style="margin-top:10px"></div>
        </div>

        <div class="col panel">
          <h3 style="margin:0">How it works</h3>
          <p class="muted">Host creates a room and shares the code. Players join with a name. Host can pick or suggest a word/phrase, then start the game.</p>
        </div>
      </div>
    </div>

    <!-- ROOM -->
    <div id="room" class="hidden">
      <div class="row">
        <div class="col panel">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><div style="font-weight:800" id="roomTitle">Room</div><div class="muted" id="roomCodeLabel"></div></div>
            <div style="text-align:right"><div class="muted">You are</div><div id="youLabel" style="font-weight:800;color:var(--accent)"></div></div>
          </div>

          <div style="margin-top:12px"><strong>Players joined:</strong><div id="playersList" style="margin-top:8px"></div></div>

          <div id="hostControls" style="margin-top:12px"></div>
          <div style="margin-top:12px"><button id="leaveBtn" class="ghost">Leave Room</button></div>
        </div>

        <div class="col panel">
          <h4 style="margin:0">Room Info</h4>
          <div class="muted" id="roomMeta"></div>
        </div>
      </div>
    </div>

    <!-- GAME -->
    <div id="game" class="hidden" style="margin-top:12px">
      <div class="row">
        <div class="col panel">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><div style="font-weight:800" id="phaseTitle">Phase</div><div class="muted" id="phaseSub"></div></div>
            <div style="text-align:right"><div class="muted">Turn</div><div id="turnLabel" style="font-weight:900;color:var(--accent)">1 / 4</div></div>
          </div>

          <!-- Draw -->
          <div id="drawPanel" style="margin-top:12px">
            <div class="muted">Instruction</div>
            <div id="instruction" style="font-weight:800;margin-top:6px"></div>
            <div style="margin-top:12px;display:flex;justify-content:center">
              <canvas id="canvas" width="720" height="430"></canvas>
            </div>

            <div class="toolbar">
              <div class="muted">Pen: black</div>
              <div style="width:12px"></div>
              <div class="muted">Size:</div>
              <button class="size-btn" data-size="4" id="sizeS">S</button>
              <button class="size-btn" data-size="8" id="sizeM">M</button>
              <button class="size-btn" data-size="14" id="sizeL">L</button>
            </div>

            <div class="controls">
              <button id="undoBtn">Undo</button>
              <button id="clearBtn" class="ghost">Clear</button>
              <div style="width:8px"></div>
              <div class="muted">Time left:</div>
              <div class="timer" id="drawTimer">60s</div>
              <button id="submitDrawBtn">Submit Drawing</button>
            </div>
          </div>

          <!-- Guess -->
          <div id="guessPanel" class="hidden" style="margin-top:12px">
            <div class="muted">Previous drawing</div>
            <div style="text-align:center;margin-top:8px"><img id="previewImg" src="" style="max-width:100%;border-radius:10px;border:1px solid #eee"></div>
            <label style="margin-top:10px">Enter guess (phrase allowed)</label>
            <input id="guessInput" type="text" placeholder="Type your guess">
            <div style="margin-top:10px;display:flex;gap:10px;align-items:center;justify-content:center">
              <div class="muted">Time left:</div>
              <div class="timer" id="guessTimer">30s</div>
              <button id="submitGuessBtn">Submit Guess</button>
            </div>
          </div>

        </div>

        <div class="col panel">
          <h4 style="margin:0">Chain</h4>
          <div class="muted">Submissions so far</div>
          <div class="summary-list" id="chainList" style="margin-top:8px"></div>
        </div>
      </div>
    </div>

    <!-- RESULTS -->
    <div id="results" class="hidden panel" style="margin-top:12px">
      <h3 style="margin-top:0">Final Results</h3>
      <div class="muted">Original word or phrase:</div>
      <div id="originalDisplay" style="font-weight:800;color:var(--accent);margin-top:6px"></div>
      <div class="summary-list" id="finalList"></div>
      <div style="margin-top:12px"><button id="backLobbyBtn">Back to Lobby</button></div>
    </div>

  </div>

  <!-- Firebase (modular v11) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, child, get, set, update, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    /* ----- Firebase config (yours) ----- */
    const firebaseConfig = {
      apiKey: "AIzaSyD6LY0o8SfAqX08h3tuLheGJQ9YOm1IKE0",
      authDomain: "telestrations-game-aa386.firebaseapp.com",
      databaseURL: "https://telestrations-game-aa386-default-rtdb.firebaseio.com/",
      projectId: "telestrations-game-aa386",
      storageBucket: "telestrations-game-aa386.firebasestorage.app",
      messagingSenderId: "461499249155",
      appId: "1:461499249155:web:c785ab9cd1c7aab44f1436"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    /* ----- Helpers ----- */
    const $ = id => document.getElementById(id);
    const genCode = () => {
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      let s=''; for(let i=0;i<4;i++) s += chars[Math.floor(Math.random()*chars.length)];
      return s;
    };
    const uid = () => 'p'+Math.random().toString(36).slice(2,9);
    const prompts = [
      "Awkward handshake","Breakfast in bed","Lost astronaut","Surfing grandma","Invisible dog",
      "Juggling flamingos","Couch potato","Dancing with wolves","Robot yoga","Time capsule",
      "Elephant on a skateboard","Synchronized napping","Haunted smartphone","Midnight snack attack",
      "Window-shopping dinosaur","Broken umbrella parade","Flying carpet commute","Secret admirer note",
      "Backwards clock","Talking mailbox","Cat's out of the bag","Under the weather",
      "Hot potato","Piece of cake","Fish out of water","Treasure map","Giraffe on roller skates",
      "Walking on eggshells","Tickled pink","Belly flop contest","Too many cooks","Lost in translation",
      "Treasure chest","Barking up the wrong tree","Two peas in a pod","Dancing queen","Rocket-powered shoes",
      "Mystery box","Midnight library","Borrowed moonlight","Painting the town red"
    ];

    /* ----- UI refs ----- */
    const home = $('home'), roomDiv=$('room'), gameDiv=$('game'), resultsDiv=$('results');
    const statusEl = $('status');
    const nameInput=$('nameInput'), playerCountInput=$('playerCount'), hostWordInput=$('hostWord'), suggestBtn=$('suggestBtn'), suggestDisplay=$('suggestDisplay');
    const createRoomBtn=$('createRoomBtn'), joinRoomBtn=$('joinRoomBtn'), createArea=$('createArea'), joinArea=$('joinArea'), codeInput=$('codeInput'), doCreateBtn=$('doCreateBtn'), doJoinBtn=$('doJoinBtn');
    const roomTitle=$('roomTitle'), roomCodeLabel=$('roomCodeLabel'), youLabel=$('youLabel'), playersList=$('playersList'), hostControls=$('hostControls'), roomMeta=$('roomMeta'), leaveBtn=$('leaveBtn');
    const phaseTitle=$('phaseTitle'), phaseSub=$('phaseSub'), turnLabel=$('turnLabel');
    const canvas=$('canvas'), ctx=canvas.getContext('2d'), instructionEl=$('instruction'), drawTimerEl=$('drawTimer'), guessTimerEl=$('guessTimer');
    const sizeBtns=document.querySelectorAll('.size-btn'), undoBtn=$('undoBtn'), clearBtn=$('clearBtn'), submitDrawBtn=$('submitDrawBtn');
    const guessPanel=$('guessPanel'), previewImg=$('previewImg'), guessInput=$('guessInput'), submitGuessBtn=$('submitGuessBtn');
    const chainList=$('chainList'), originalDisplay=$('originalDisplay'), finalList=$('finalList'), backLobbyBtn=$('backLobbyBtn');

    /* ----- Local state ----- */
    let myId=null,myName=null,currentRoom=null,roomListenerUnsub=null,gameListenerUnsub=null;
    let penSize=8,strokes=[],undoneStrokes=[];
    let drawTimerInt=null,guessTimerInt=null;

    /* ----- Canvas drawing ----- */
    function setSize(sz){ penSize=sz; sizeBtns.forEach(b=>b.classList.toggle('active', parseInt(b.dataset.size)===sz)); }
    sizeBtns.forEach(b=>b.addEventListener('click', ()=> setSize(parseInt(b.dataset.size)))); setSize(8);

    function getPos(e){
      const r = canvas.getBoundingClientRect();
      const clientX = e.clientX || (e.touches && e.touches[0].clientX);
      const clientY = e.clientY || (e.touches && e.touches[0].clientY);
      return { x: clientX - r.left, y: clientY - r.top };
    }
    let drawing=false,currentStroke=null;
    canvas.addEventListener('mousedown', e=>{ drawing=true; currentStroke={size:penSize,pts:[]}; strokes.push(currentStroke); currentStroke.pts.push(getPos(e)); redraw(); });
    canvas.addEventListener('mousemove', e=>{ if(!drawing) return; currentStroke.pts.push(getPos(e)); redraw(); });
    document.addEventListener('mouseup', ()=>{ drawing=false; currentStroke=null; });
    canvas.addEventListener('touchstart', e=>{ e.preventDefault(); drawing=true; currentStroke={size:penSize,pts:[]}; strokes.push(currentStroke); currentStroke.pts.push(getPos(e)); redraw(); }, {passive:false});
    canvas.addEventListener('touchmove', e=>{ e.preventDefault(); if(!drawing) return; currentStroke.pts.push(getPos(e)); redraw(); }, {passive:false});
    document.addEventListener('touchend', ()=>{ drawing=false; currentStroke=null; });

    undoBtn.addEventListener('click', ()=>{ if(strokes.length){ undoneStrokes.push(strokes.pop()); redraw(); } });
    clearBtn.addEventListener('click', ()=>{ if(confirm('Clear canvas?')){ strokes=[]; undoneStrokes=[]; redraw(); } });

    function redraw(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.lineCap='round'; ctx.lineJoin='round';
      for(const s of strokes){
        ctx.beginPath(); ctx.lineWidth = s.size; ctx.strokeStyle='#000';
        for(let i=0;i<s.pts.length;i++){ const p=s.pts[i]; if(i===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y); }
        ctx.stroke();
      }
    }

    /* ----- Lobby actions ----- */
    createRoomBtn.addEventListener('click', ()=>{ createArea.style.display='block'; joinArea.style.display='none'; });
    joinRoomBtn.addEventListener('click', ()=>{ joinArea.style.display='block'; createArea.style.display='none'; });
    suggestBtn.addEventListener('click', ()=>{ const w=prompts[Math.floor(Math.random()*prompts.length)]; hostWordInput.value=''; suggestDisplay.textContent=w; suggestDisplay.dataset.word=w; });

    doCreateBtn.addEventListener('click', async ()=>{
      const name=(nameInput.value||'').trim(); const pcount=parseInt(playerCountInput.value);
      let word=(hostWordInput.value||'').trim();
      if(!name) return alert('Enter your name'); if(!pcount||pcount<3||pcount>12) return alert('Choose 3‚Äì12 players');
      if(!word) word = suggestDisplay.dataset.word || prompts[Math.floor(Math.random()*prompts.length)];
      myId = uid(); myName=name;
      let code = genCode();
      // try to avoid collisions
      let tries=0;
      while((await get(child(ref(db), 'rooms/'+code))).exists() && tries<8){ code = genCode(); tries++; }
      currentRoom = code;
      const roomObj = {
        code, hostId: myId, hostName: name, playerCount: pcount, word, started:false,
        order:null, currentIndex:0, createdAt: Date.now(),
        players: { [myId]: { id: myId, name } },
        gameData: {}
      };
      await set(ref(db, 'rooms/'+code), roomObj);
      localStorage.setItem('teles_current', JSON.stringify({roomCode:code,myId,myName:name}));
      openRoom(code);
    });

    doJoinBtn.addEventListener('click', async ()=>{
      const name=(nameInput.value||'').trim(); const code=(codeInput.value||'').trim().toUpperCase();
      if(!name) return $('joinMsg').textContent='Enter your name';
      if(!code) return $('joinMsg').textContent='Enter room code';
      const snap = await get(ref(db, 'rooms/'+code));
      if(!snap.exists()) return $('joinMsg').textContent='Room not found';
      const room = snap.val();
      if(room.started) return $('joinMsg').textContent='Game already started';
      const currentPlayers = Object.keys(room.players||{}).length;
      if(currentPlayers >= (room.playerCount||3)) return $('joinMsg').textContent='Room full';
      myId = uid(); myName=name; currentRoom=code;
      await set(ref(db, `rooms/${code}/players/${myId}`), { id: myId, name: myName });
      localStorage.setItem('teles_current', JSON.stringify({roomCode:code,myId,myName:name}));
      openRoom(code);
    });

    /* ----- Open room and live updates ----- */
    function openRoom(code){
      home.classList.add('hidden'); roomDiv.classList.remove('hidden'); gameDiv.classList.add('hidden'); resultsDiv.classList.add('hidden');
      if(roomListenerUnsub) roomListenerUnsub();
      roomListenerUnsub = onValue(ref(db, 'rooms/'+code), snap => {
        const room = snap.val();
        if(!room){ alert('Room closed'); localStorage.removeItem('teles_current'); location.reload(); return; }
        renderRoom(room);
        if(room.started) openGame(room);
      });
    }

    function renderRoom(room){
      roomTitle.textContent = 'Room ‚Äî ' + room.code;
      roomCodeLabel.textContent = 'Code: ' + room.code;
      youLabel.textContent = myName || '';
      playersList.innerHTML = '';
      const players = room.players || {};
      Object.values(players).forEach(p => {
        const d = document.createElement('div'); d.style.padding='6px 0'; d.innerHTML = `<strong>${p.name}</strong> ${p.id===room.hostId?'<span class="muted">(host)</span>':''}`;
        playersList.appendChild(d);
      });
      hostControls.innerHTML = '';
      if(myId === room.hostId && !room.started){
        const start = document.createElement('button'); start.textContent='Start Game'; start.onclick = ()=> startGame(room.code);
        hostControls.appendChild(start);
        const info=document.createElement('div'); info.className='muted'; info.style.marginTop='8px';
        info.textContent = `Chosen: "${room.word}" ‚Ä¢ Players required: ${room.playerCount}`;
        hostControls.appendChild(info);
      } else {
        const info=document.createElement('div'); info.className='muted'; info.style.marginTop='8px';
        info.textContent = room.started ? 'Game in progress' : 'Waiting for host to start';
        hostControls.appendChild(info);
      }
      roomMeta.textContent = `Host: ${room.hostName} ‚Ä¢ Players required: ${room.playerCount}`;
      leaveBtn.onclick = async ()=>{
        try{
          const snap = await get(ref(db, 'rooms/'+room.code));
          const r = snap.val();
          if(r){
            const ps = r.players || {};
            for(const k in ps){ if(ps[k].id===myId) await set(ref(db, `rooms/${room.code}/players/${k}`), null); }
            if(myId===r.hostId) await set(ref(db, 'rooms/'+room.code), null);
          }
        }catch(e){ console.error(e); }
        localStorage.removeItem('teles_current'); location.reload();
      };
    }

    /* ----- Start game: order = host then randomized others ----- */
    async function startGame(code){
      const snap = await get(ref(db, 'rooms/'+code)); if(!snap.exists()) return;
      const room = snap.val();
      const playersArr = Object.values(room.players||{});
      const hostId = room.hostId;
      const others = playersArr.filter(p=>p.id!==hostId).map(p=>p.id);
      for(let i=others.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [others[i],others[j]]=[others[j],others[i]]; }
      const order = [hostId, ...others];
      await update(ref(db, 'rooms/'+code), { order, started:true, currentIndex:0 });
    }

    /* ----- Game screen updates ----- */
    function openGame(room){
      roomDiv.classList.add('hidden'); gameDiv.classList.remove('hidden'); resultsDiv.classList.add('hidden');
      if(gameListenerUnsub) gameListenerUnsub();
      gameListenerUnsub = onValue(ref(db, 'rooms/'+room.code), snap => {
        const r = snap.val(); if(!r){ alert('Room removed'); location.reload(); return; }
        renderGame(r);
      });
    }

    function renderGame(room){
      currentRoom = room.code;
      const total = room.playerCount || (room.order? room.order.length : 1);
      const idx = room.currentIndex || 0;
      turnLabel.textContent = (idx+1) + ' / ' + total;
      if(idx >= total){ showResults(room); return; }

      const order = room.order || [];
      const currentPlayerId = order[idx];
      const currentPlayerName = (room.players && room.players[currentPlayerId]) ? room.players[currentPlayerId].name : `Player ${idx+1}`;
      const isDraw = (idx % 2 === 0); // host draws first
      phaseTitle.textContent = isDraw ? 'Drawing Turn' : 'Guessing Turn';
      phaseSub.textContent = `Player ${idx+1}: ${currentPlayerName}`;

      renderChain(room);

      if(myId === currentPlayerId){
        if(isDraw) enableDraw(room); else enableGuess(room);
      } else {
        showWaiting(currentPlayerName);
      }
    }

    function renderChain(room){
      chainList.innerHTML='';
      const g = room.gameData || {};
      const keys = Object.keys(g).map(k=>parseInt(k)).sort((a,b)=>a-b);
      keys.forEach(k=>{
        const e = g[k];
        const div=document.createElement('div'); div.className='chain-item';
        div.innerHTML = `<strong>Turn ${k+1} ‚Äî ${e.playerName || 'Player'}</strong> ‚Äî ${e.type==='draw'?'Drew':'Guessed'}`;
        if(e.type==='draw'){ const img=document.createElement('img'); img.src=e.data; img.style.maxWidth='100%'; img.style.marginTop='8px'; div.appendChild(img); }
        else { const p=document.createElement('div'); p.textContent=e.data; p.style.marginTop='8px'; div.appendChild(p); }
        chainList.appendChild(div);
      });
    }

    /* ----- Draw turn ----- */
    function enableDraw(room){
      $('drawPanel').classList.remove('hidden');
      guessPanel.classList.add('hidden');
      const idx = room.currentIndex||0;
      if(idx===0) instructionEl.textContent = `Draw this word or phrase: "${room.word}"`;
      else {
        const prev = room.gameData && room.gameData[idx-1];
        instructionEl.textContent = `Draw this phrase: "${prev? prev.data : ''}"`;
      }
      strokes=[]; undoneStrokes=[]; redraw(); setSize(8);
      if(drawTimerInt) clearInterval(drawTimerInt);
      let t=60; drawTimerEl.textContent = t+'s';
      drawTimerInt = setInterval(()=>{ t--; drawTimerEl.textContent=t+'s'; if(t<=0){ clearInterval(drawTimerInt); submitDrawing(); } },1000);
    }

    async function submitDrawing(){
      if(drawTimerInt){ clearInterval(drawTimerInt); drawTimerInt=null; drawTimerEl.textContent='60s'; }
      const data = canvas.toDataURL('image/png');
      const snap = await get(ref(db, 'rooms/'+currentRoom)); if(!snap.exists()) return;
      const room = snap.val(); const idx = room.currentIndex||0;
      const updates = {};
      updates['rooms/'+currentRoom+'/gameData/'+idx] = { type:'draw', data, playerId: myId, playerName: myName };
      updates['rooms/'+currentRoom+'/currentIndex'] = idx+1;
      await update(ref(db), updates);
    }

    /* ----- Guess turn ----- */
    function enableGuess(room){
      $('drawPanel').classList.add('hidden');
      guessPanel.classList.remove('hidden');
      const idx=room.currentIndex||0;
      const prev = room.gameData && room.gameData[idx-1];
      previewImg.src = prev && prev.type==='draw' ? prev.data : '';
      guessInput.value='';
      if(guessTimerInt) clearInterval(guessTimerInt);
      let t=30; guessTimerEl.textContent = t+'s';
      guessTimerInt = setInterval(()=>{ t--; guessTimerEl.textContent=t+'s'; if(t<=0){ clearInterval(guessTimerInt); submitGuess(); } },1000);
    }

    async function submitGuess(){
      if(guessTimerInt){ clearInterval(guessTimerInt); guessTimerInt=null; guessTimerEl.textContent='30s'; }
      const val = (guessInput.value||'').trim() || 'No guess';
      const snap = await get(ref(db, 'rooms/'+currentRoom)); if(!snap.exists()) return;
      const room = snap.val(); const idx = room.currentIndex||0;
      const updates = {};
      updates['rooms/'+currentRoom+'/gameData/'+idx] = { type:'guess', data: val, playerId: myId, playerName: myName };
      updates['rooms/'+currentRoom+'/currentIndex'] = idx+1;
      await update(ref(db), updates);
    }

    /* ----- Waiting view for non-turn players ----- */
    function showWaiting(playerName){
      $('drawPanel').classList.add('hidden');
      guessPanel.classList.add('hidden');
      phaseTitle.textContent = 'Waiting';
      phaseSub.textContent = `Waiting for ${playerName} to take their turn`;
      if(drawTimerInt){ clearInterval(drawTimerInt); drawTimerInt=null; drawTimerEl.textContent='60s'; }
      if(guessTimerInt){ clearInterval(guessTimerInt); guessTimerInt=null; guessTimerEl.textContent='30s'; }
    }

    /* ----- Results ----- */
    function showResults(room){
      gameDiv.classList.add('hidden');
      resultsDiv.classList.remove('hidden');
      originalDisplay.textContent = room.word || '';
      finalList.innerHTML='';
      const g = room.gameData || {};
      const keys = Object.keys(g).map(k=>parseInt(k)).sort((a,b)=>a-b);
      keys.forEach(k=>{
        const e = g[k];
        const div=document.createElement('div'); div.className='chain-item';
        div.innerHTML = `<strong>Turn ${k+1} ‚Äî ${e.playerName || 'Player'}</strong> ‚Äî ${e.type==='draw'?'Drew':'Guessed'}`;
        if(e.type==='draw'){ const img=document.createElement('img'); img.src=e.data; img.style.maxWidth='100%'; img.style.marginTop='8px'; div.appendChild(img); }
        else { const p=document.createElement('div'); p.textContent=e.data; p.style.marginTop='8px'; div.appendChild(p); }
        finalList.appendChild(div);
      });
    }

    /* ----- Buttons ----- */
    submitDrawBtn.addEventListener('click', submitDrawing);
    submitGuessBtn.addEventListener('click', submitGuess);
    backLobbyBtn.addEventListener('click', ()=>{ localStorage.removeItem('teles_current'); location.reload(); });

    /* ----- Resume if tab refresh ----- */
    (function resume(){
      try{
        const cur = JSON.parse(localStorage.getItem('teles_current')||'null');
        if(!cur) return;
        myId=cur.myId; myName=cur.myName; currentRoom=cur.roomCode;
        get(ref(db, 'rooms/'+currentRoom)).then(snap=>{
          if(!snap.exists()){ localStorage.removeItem('teles_current'); return; }
          openRoom(currentRoom);
        }).catch(()=> localStorage.removeItem('teles_current'));
      }catch(e){}
    })();

    /* ----- Connection status ----- */
    onValue(ref(db, '.info/connected'), snap=>{
      statusEl.textContent = snap.val() ? 'Connected to Firebase ‚úÖ' : 'Disconnected ‚ùå';
    });
  </script>
</body>
</html>
